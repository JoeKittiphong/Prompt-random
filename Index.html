<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prompt Generator — Coloring Book</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#7c3aed;
  --glass: rgba(255,255,255,0.03);
}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:linear-gradient(180deg,#071022 0%, #081127 100%);color:#e6eef8}
.wrap{max-width:980px;margin:28px auto;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
h1{margin:0 0 12px;font-size:20px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
.card{background:var(--card);padding:14px;border-radius:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.row{display:flex;gap:8px;align-items:center}
/* Custom row layout for better mobile preset view */
.preset-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap; /* Added for responsiveness */
}
.preset-row input[type="text"] {
    flex-grow: 1; /* Allows name input to take maximum space */
    min-width: 120px;
}
.preset-row select {
    flex-grow: 1;
    min-width: 100px;
}
.preset-row button {
    flex-shrink: 0;
}
@media (max-width: 500px) {
    .preset-row {
        flex-direction: column; /* Stack controls on very small screens */
        align-items: stretch;
    }
    .preset-row > * {
        margin-bottom: 4px; /* Space between stacked items */
        width: 100%; /* Full width for stacked items */
    }
    /* Reset input/select flex properties when stacked */
    .preset-row input[type="text"],
    .preset-row select {
        flex-grow: 1;
        width: 100%;
    }
    .preset-row div.row { /* Fix for nested rows (like delete button) */
        width: 100%;
    }
}
/* End Custom row layout */

input[type="text"], input[type="number"], select, textarea{
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px;
}
button{background:var(--accent);color:white;padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
.small{padding:6px 8px;font-size:13px}
.styles-list{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.characters{display:flex;flex-direction:column;gap:8px}
.char-row{display:flex;gap:8px}
.char-row input{flex:1}
.result-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding-right:6px}
.result-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.result-item .text{flex:1;margin-right:12px}
.result-item.struck .text{text-decoration:line-through;color:rgba(255,255,255,0.45)}
.muted{color:var(--muted);font-size:13px}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px}
.actions{display:flex;gap:8px;align-items:center}
.small-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:6px;color:var(--muted)}
@media (max-width:880px){
  .grid{grid-template-columns:1fr; padding-bottom:12px}
  .card{margin-bottom:12px}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>Prompt Generator — Coloring Book (single file)</h1>
  <div class="grid">
    <div class="card" id="inputsCard">

      <div>
        <label>1) สไตล์ภาพ (Style) <span class="muted">- เพิ่ม/ลบ/ลากวาง/แก้ไขได้</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="styleSelect" aria-label="Style select"></select>
          <button id="toggleStyleControls" class="ghost small">แก้ไขสไตล์</button>
        </div>
        <div id="styleControls" style="margin-top:10px;display:none">
          <div class="styles-list" id="stylesList"></div>
          <div class="row" style="margin-top:8px">
            <input type="text" id="newStyleInput" placeholder="พิมพ์สไตล์ใหม่ เช่น Kawaii line art" />
            <button id="addStyleBtn" class="small">เพิ่ม</button>
            <button id="clearStylesBtn" class="small-ghost ghost">ล้างทั้งหมด</button>
          </div>
          <div class="muted" style="margin-top:8px">เลือกสไตล์จาก dropdown เพื่อใช้เป็นต้นแบบเวลา Generate</div>
        </div>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>

      <div>
        <label>2) บันทึก/โหลด Preset (Characters, Poses, Backgrounds)</label>
        <div class="preset-row"> <input type="text" id="presetNameInput" placeholder="ตั้งชื่อ Preset"/>
          <button id="savePresetBtn" class="small">บันทึก</button>
          <select id="loadPresetSelect" aria-label="Load Preset">
            <option value="">-- เลือก --</option>
          </select>
          <button id="loadPresetBtn" class="small-ghost ghost">โหลด</button>
        </div>
        <div class="row" style="margin-top:8px">
            <button id="deletePresetBtn" class="small-ghost ghost">ลบ Preset ที่เลือก</button>
        </div>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>

      <div>
        <label>3) ตัวละคร (Characters) <span class="muted">- เพิ่ม/ลบช่องได้</span></label>
        <div class="characters" id="charactersContainer"></div>
        <div style="margin-top:8px" class="row">
          <button id="addCharBtn" class="small">เพิ่มตัวละคร</button>
          <button id="importCharsBtn" class="small-ghost ghost">นำเข้าจาก CSV</button>
          <div class="muted" style="margin-left:auto">เก็บชั่วคราวในเซสชัน</div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>

      <div>
        <label>4) ท่าทาง / การแสดงออก (คั่นด้วย , )</label>
        <input type="text" id="posesInput" placeholder="ตัวอย่าง: ยิ้ม, นั่ง, กำลังวิ่ง" />
        <div class="muted" style="margin-top:6px">ระบบจะแยกแต่ละคำด้วยเครื่องหมายจุลภาคแล้วสุ่มใช้</div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>

      <div>
        <label>5) พื้นหลัง / องค์ประกอบเพิ่มเติม (คั่นด้วย ,)</label>
        <input type="text" id="bgInput" placeholder="สวนดอกไม้, ห้องเรียน, ทุ่งหญ้า" />
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>

      <div>
        <label>ตัวเลือก</label>
        <div class="row">
          <div style="width:140px">
            <label class="muted" style="font-size:12px;margin-bottom:6px">ผลลัพธ์ที่ต้องการ</label>
            <input type="number" id="resultCount" min="1" max="200" value="10" />
          </div>
          <div style="margin-left:auto" class="row">
            <button id="generateBtn">Generate</button>
            <button id="clearResultsBtn" class="ghost small">ล้างผลลัพธ์</button>
          </div>
        </div>
      </div>

    </div>

    <div class="card">
      <label>ผลลัพธ์ (คลิกที่รายการเพื่อ toggle ขีดฆ่า — กดปุ่ม Copy เพื่อคัดลอก)</label>
      <div id="results" class="result-list" aria-live="polite"></div>

      <div class="footer">
        <div class="muted" id="stats">0 prompts shown</div>
        <div class="actions">
          <button id="copyAllBtn" class="small">Copy All</button>
          <button id="exportBtn" class="small-ghost ghost">Export .txt</button>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
(() => {
const $=s=>document.querySelector(s);
const trimNonEmpty=s=>s.split(',').map(x=>x.trim()).filter(Boolean);

const styleSelect=$('#styleSelect');
const styleControls=$('#styleControls');
const toggleStyleControls=$('#toggleStyleControls');
const stylesList=$('#stylesList');
const newStyleInput=$('#newStyleInput');
const addStyleBtn=$('#addStyleBtn');
const clearStylesBtn=$('#clearStylesBtn');

const presetNameInput=$('#presetNameInput');
const savePresetBtn=$('#savePresetBtn');
const loadPresetSelect=$('#loadPresetSelect');
const loadPresetBtn=$('#loadPresetBtn');
const deletePresetBtn=$('#deletePresetBtn');

const charactersContainer=$('#charactersContainer');
const addCharBtn=$('#addCharBtn');
const importCharsBtn=$('#importCharsBtn');

const posesInput=$('#posesInput');
const bgInput=$('#bgInput');

const resultCount=$('#resultCount');
const generateBtn=$('#generateBtn');
const results=$('#results');
const clearResultsBtn=$('#clearResultsBtn');
const stats=$('#stats');
const copyAllBtn=$('#copyAllBtn');
const exportBtn=$('#exportBtn');

const LS_STYLES='cg_styles_v1';
const LS_PRESETS='cg_presets_v1'; 
let styles=JSON.parse(localStorage.getItem(LS_STYLES)||'null')||['Kawaii line art','Simple cartoon style','Bold outline coloring style'];
let presets=JSON.parse(localStorage.getItem(LS_PRESETS)||'null')||{}; 
let characters=['เด็กผู้หญิง','หมาน้อย'];
let lastResults=[];

function saveStyles(){localStorage.setItem(LS_STYLES,JSON.stringify(styles));}
function savePresets(){localStorage.setItem(LS_PRESETS,JSON.stringify(presets));}

function renderStyleSelect(){styleSelect.innerHTML='';styles.forEach(s=>{const opt=document.createElement('option');opt.value=s;opt.textContent=s;styleSelect.appendChild(opt);});}
function renderStylesList(){
  stylesList.innerHTML='';
  styles.forEach((s,idx)=>{
    const chip=document.createElement('div');
    chip.className='chip';chip.draggable=true;chip.style.display='flex';chip.style.alignItems='center';chip.style.gap='6px';

    chip.addEventListener('click',()=>{
      if(chip._editing) return; chip._editing=true;
      const input=document.createElement('input');
      input.type='text'; input.value=s; input.style.width='140px'; input.style.fontSize='13px'; input.style.padding='4px 6px';
      chip.innerHTML=''; chip.appendChild(input); input.focus();
      input.addEventListener('blur',()=>{const v=input.value.trim()||s;styles[idx]=v;saveStyles();renderAllStyles();});
      input.addEventListener('keydown',e=>{if(e.key==='Enter')input.blur();});
    });

    const del=document.createElement('button'); del.className='small-ghost ghost'; del.textContent='ลบ';
    del.addEventListener('click',e=>{e.stopPropagation();styles.splice(idx,1);saveStyles();renderAllStyles();});
    chip.appendChild(document.createTextNode(s)); chip.appendChild(del);

    chip.addEventListener('dragstart',ev=>{ev.dataTransfer.setData('text/plain',idx);chip.style.opacity='0.4';});
    chip.addEventListener('dragend',()=>{chip.style.opacity='1';});
    chip.addEventListener('dragover',ev=>{ev.preventDefault();chip.style.background='rgba(255,255,255,0.08)';});
    chip.addEventListener('dragleave',()=>{chip.style.background='rgba(255,255,255,0.03)';});
    chip.addEventListener('drop',ev=>{ev.preventDefault();chip.style.background='rgba(255,255,255,0.03)';const from=parseInt(ev.dataTransfer.getData('text/plain'),10);const to=idx;if(from===to)return;const moved=styles.splice(from,1)[0];styles.splice(to,0,moved);saveStyles();renderAllStyles();});
    stylesList.appendChild(chip);
  });
}
function renderAllStyles(){renderStyleSelect();renderStylesList();}

function renderChars(){charactersContainer.innerHTML='';characters.forEach((c,idx)=>{const row=document.createElement('div');row.className='char-row';const input=document.createElement('input');input.type='text';input.value=c;input.placeholder='ตัวละคร เช่น cat, panda, boy';input.addEventListener('input',e=>characters[idx]=e.target.value);const del=document.createElement('button');del.className='small-ghost ghost';del.textContent='ลบ';del.addEventListener('click',()=>{characters.splice(idx,1);renderChars();});row.appendChild(input);row.appendChild(del);charactersContainer.appendChild(row);});}

function renderPresetSelect(){
    loadPresetSelect.innerHTML='<option value="">-- เลือก --</option>';
    Object.keys(presets).forEach(name=>{
        const opt=document.createElement('option');
        opt.value=name;
        opt.textContent=name;
        loadPresetSelect.appendChild(opt);
    });
}

function uniqueRandomPick(list,count){const arr=[...list];const out=[];while(out.length<count && arr.length>0){const i=Math.floor(Math.random()*arr.length);out.push(arr.splice(i,1)[0]);}return out;}

function genSinglePrompt(style,character,pose,bg){const parts=[];if(style)parts.push(style);if(character)parts.push("of a "+character);if(pose)parts.push(pose);if(bg)parts.push("in "+bg);return parts.join(' ').replace(/\s+/g,' ').trim();}

function generatePrompts(count){
  const chars=characters.map(x=>x.trim()).filter(Boolean);
  const poses=trimNonEmpty(posesInput.value);
  const bgs=trimNonEmpty(bgInput.value);
  const pickStyles=uniqueRandomPick(styles,count);
  const pickChars=uniqueRandomPick(chars,count);
  const pickPoses=uniqueRandomPick(poses,count);
  const pickBGs=uniqueRandomPick(bgs,count);
  const res=[];
  for(let i=0;i<count;i++){
    const style=pickStyles[i%pickStyles.length]||'';
    const char=pickChars[i%pickChars.length]||'';
    const pose=pickPoses[i%pickPoses.length]||'';
    const bg=pickBGs[i%pickBGs.length]||'';
    res.push({text:genSinglePrompt(style,char,pose,bg),struck:false});
  }
  lastResults=res;renderResults();
}

function updateStats(){stats.textContent=`${lastResults.length} prompts shown`;}
function renderResults(){results.innerHTML='';lastResults.forEach((r,idx)=>{const item=document.createElement('div');item.className='result-item'+(r.struck?' struck':'');item.addEventListener('click',e=>{if(e.target.closest('button'))return;r.struck=!r.struck;renderResults();});const text=document.createElement('div');text.className='text';text.textContent=r.text;const copyBtn=document.createElement('button');copyBtn.className='small';copyBtn.textContent='Copy';copyBtn.addEventListener('click',async ev=>{ev.stopPropagation();await navigator.clipboard.writeText(r.text);r.struck=true;renderResults();});item.appendChild(text);item.appendChild(copyBtn);results.appendChild(item);});updateStats();}

// Event Listeners for Preset Control
savePresetBtn.addEventListener('click',()=>{
    const name=presetNameInput.value.trim();
    if(!name){
        alert("กรุณาใส่ชื่อ Preset");
        return;
    }
    // ใช้ .map(c=>c.trim()).filter(Boolean) เพื่อทำความสะอาด characters ก่อนบันทึก
    characters=characters.map(c=>c.trim()).filter(Boolean); 
    presets[name]={
        characters: characters,
        // ใช้ .trim() เพื่อทำความสะอาด poses และ bgs ก่อนบันทึก
        poses: posesInput.value.trim(), 
        bgs: bgInput.value.trim(), 
    };
    savePresets();
    renderPresetSelect();
    loadPresetSelect.value=name;
    alert(`บันทึก Preset "${name}" เรียบร้อยแล้ว`);
});

loadPresetBtn.addEventListener('click',()=>{
    const name=loadPresetSelect.value;
    if(!name){
        alert("กรุณาเลือก Preset ที่ต้องการโหลด");
        return;
    }
    const preset=presets[name];
    if(preset){
        characters=preset.characters;
        posesInput.value=preset.poses;
        bgInput.value=preset.bgs;
        renderChars();
        presetNameInput.value=name;
        alert(`โหลด Preset "${name}" เรียบร้อยแล้ว`);
    }
});

deletePresetBtn.addEventListener('click',()=>{
    const name=loadPresetSelect.value;
    if(!name){
        alert("กรุณาเลือก Preset ที่ต้องการลบ");
        return;
    }
    if(confirm(`ยืนยันการลบ Preset "${name}"?`)){
        delete presets[name];
        savePresets();
        renderPresetSelect();
        presetNameInput.value='';
        alert(`ลบ Preset "${name}" เรียบร้อยแล้ว`);
    }
});

toggleStyleControls.addEventListener('click',()=>{const show=styleControls.style.display!=='block';styleControls.style.display=show?'block':'none';toggleStyleControls.textContent=show?'ซ่อนสไตล์':'แก้ไขสไตล์';});
addStyleBtn.addEventListener('click',()=>{const v=newStyleInput.value.trim();if(!v)return;styles.unshift(v);newStyleInput.value='';saveStyles();renderAllStyles();styleSelect.value=v;});
clearStylesBtn.addEventListener('click',()=>{if(!confirm('ลบสไตล์ทั้งหมด?'))return;styles=[];saveStyles();renderAllStyles();});
addCharBtn.addEventListener('click',()=>{characters.push('');renderChars();});
importCharsBtn.addEventListener('click',()=>{const csv=prompt("วางรายการตัวละคร (คั่นด้วย ,)");if(csv){characters=characters.concat(csv.split(',').map(x=>x.trim()).filter(Boolean));renderChars();}});
generateBtn.addEventListener('click',()=>{const n=parseInt(resultCount.value,10);if(n<=0)return alert("ต้องการจำนวน > 0");characters=characters.map(c=>c.trim()).filter(Boolean);generatePrompts(n);});
clearResultsBtn.addEventListener('click',()=>{if(!confirm('ล้างผลลัพธ์ทั้งหมด?'))return;lastResults=[];renderResults();});
copyAllBtn.addEventListener('click',async()=>{if(!lastResults.length)return alert("ไม่มีผลลัพธ์");const txt=lastResults.map(r=>r.text).join("\n");await navigator.clipboard.writeText(txt);lastResults.forEach(r=>r.struck=true);renderResults();});
exportBtn.addEventListener('click',()=>{const txt=lastResults.map(r=>r.text).join("\n");const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download="prompts.txt";a.click();URL.revokeObjectURL(url);});

function init(){renderAllStyles();renderChars();renderResults();renderPresetSelect();styleControls.style.display='none';}
init();
})();
</script>
</body>
</html>
